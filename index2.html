<!doctype html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css"
        type="text/css">


    <title>Bus Tracker</title>
</head>

<body>
    <h1><center>Bus Location</center></h1>
    <div id="map" style="width: 100%; height: 100%;"></div>
    <div id="pointerLayer"></div>
    <div id="mapLayer"></div>
    <input id="latitude" type="hidden" />
    <input id="longitude" type="hidden" />

    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>

    <script type="text/javascript">

        function getBusLocation() {

            const Http = new XMLHttpRequest();

            const url = 'https://api.thingspeak.com/channels/1396851/feeds/last.json?api_key=ZJSLHTCLC629PNM2';
            Http.open("GET", url);
            Http.send();

            Http.onreadystatechange = (e) => {
                if (Http.readyState === 4) {

                    var obj = JSON.parse(Http.response);

                    //var latitude = obj.field1
                    //var longitude = obj.field2

                    document.getElementById("longitude").value = longitude
                    document.getElementById("latitude").value = latitude
                    if(setUpDone){
                        console.log("entering into non-setup")
                        var map = document.getElementById("mapLayer").value
                        centerMapToNewCoordinatesAndRemovePointerLayer(longitude, latitude, map)
                        map.addLayer(getPointerLayer(longitude, latitude))
                    }
                    else {
                        setUpMap()
                    }
                    latitude = latitude + 0.0002
                    longitude = longitude + 0.0002

                }
            }
        }

        var longitude = 78.526405
        var latitude = 17.383179
        var setUpDone = false
        getBusLocation()
        setInterval(getBusLocation, 3000);

        function setUpMap() {
            var longitude = Number(document.getElementById("longitude").value)
            var latitude = Number(document.getElementById("latitude").value)
            console.log(longitude + " : " + latitude)

            var map = setUpMapLayer(latitude, longitude)

            var layer = getPointerLayer(longitude, latitude)
            map.addLayer(layer)

            setUpDone = true
            console.log("Map setup is done")

            document.getElementById("mapLayer").value = map
            return map
        }


        function getPointerLayer(lon, lat){
           var layer =  new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [
                        new ol.Feature({
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat]))
                        })
                    ]
                }),
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        src: 'bus.png'
                    })
                })
            });

            document.getElementById("pointerLayer").value = layer

            return layer
        }


        function removePointerLayer(map) {
            map.removeLayer(document.getElementById("pointerLayer").value)
        }

        function setUpMapLayer(latitude, longitude) {

            var attribution = new ol.control.Attribution({
                collapsible: false
            });

            var map = new ol.Map({
                controls: ol.control.defaults({ attribution: false }).extend([attribution]),
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    })
                ],
                target: 'map',
                view: new ol.View({
                    center: ol.proj.fromLonLat([longitude, latitude]),
                    maxZoom: 18,
                    zoom: 16
                })
            });

            return map
        }

        function centerMapToNewCoordinatesAndRemovePointerLayer(long, lat, map) {
            console.log("Long: " + long + " Lat: " + lat);
            map.getView().setCenter(ol.proj.fromLonLat([longitude, latitude]));
            removePointerLayer(map)
            return map
        }

    </script>
</body>

</html>